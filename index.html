<!DOCTYPE html>
<html lang="en">
	<head>
		<!-- Google tag (gtag.js) -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-VEVHWBPKXD"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());

			gtag("config", "G-VEVHWBPKXD");
		</script>

		<meta charset="UTF-8" />
		<link rel="icon" type="image/x-icon" href="favicon.ico" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0"
		/>

		<!-- Socials -->
		<meta name="title" content="mGira" />
		<meta name="og:title" content="mGira" />
		<meta name="image" content="https://app.mgira.pt/assets/images/mGira_social.png" />
		<meta name="og:image" content="https://app.mgira.pt/assets/images/mGira_social.png" />
		<meta name="og:url" content="https://app.mgira.pt" />
		<meta
			name="description"
			content="Uma melhor aplicação para o sistema de bicicletas partilhadas GIRA. Experimenta já!"
		/>
		<meta
			property="og:description"
			content="Uma melhor aplicação para o sistema de bicicletas partilhadas GIRA. Experimenta já!"
		/>
		<meta name="author" content="afonsosousah" />
		<meta property="og:type" content="website" />
		<meta property="og:locale" content="pt_PT" />

		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		<link rel="manifest" href="manifest.json" />
		<meta name="theme-color" content="#ffffff" />

		<title>mGira</title>

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.1.0/ol.css" />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
		<link rel="stylesheet" href="assets/style.css" />

		<!-- JS imports -->
		<script src="scripts/bikeSerialNumberMapping.js"></script>
		<script src="scripts/tokenRefresh.js"></script>
		<script src="scripts/requests.js"></script>
		<script src="scripts/user.js"></script>
		<script src="scripts/bikes.js"></script>
		<script src="scripts/stations.js"></script>
		<script src="scripts/map.js"></script>
		<script src="scripts/routing.js"></script>
		<script src="scripts/navigation.js"></script>
		<script src="scripts/dialogs.js"></script>
		<script src="scripts/extras.js"></script>
		<script src="scripts/swipe.js"></script>
		<script src="scripts/version.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
		<script type="module" src="https://unpkg.com/openrouteservice-js@0.3.2/dist/ors-js-client.js"></script>
		<script src=" https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js "></script>
	</head>
	<body onload="initMap();">
		<!-- Map -->
		<div id="map"></div>
		<div id="mapOverlay"></div>

		<!-- Zoom controls -->
		<div id="zoomControls">
			<div id="zoomPlusButton" onclick="zoomIn()">
				<i class="bi bi-plus"></i>
			</div>
			<div id="zoomMinusButton" onclick="zoomOut()">
				<i class="bi bi-dash"></i>
			</div>
			<div id="getLocationButton" onclick="getLocation()">
				<i class="bi bi-crosshair"></i>
			</div>
		</div>

		<!-- Logo -->
		<img id="logo" src="assets/images/mGira_big.png" alt="big logo" />

		<!-- Navigation button -->
		<div id="navigationButton" onclick="showSearchBar()">
			<img src="assets/images/navArrow.png" alt="navigation arrow" />
		</div>

		<!-- User picture -->
		<div id="userPicture" onclick="openUserSettings()">
			<div id="userInitials"></div>
		</div>

		<!-- Scripts -->
		<script>
			// Register the web app service worker
			if ("serviceWorker" in navigator) {
				navigator.serviceWorker.register("scripts/serviceworker.js");
			}

			// Check if location permission is given
			navigator.permissions.query({ name: "geolocation" }).then(result => {
				if (result.state === "granted") {
					// Don't do anything
				} else if (result.state === "prompt") {
					console.log("Location permission will be prompted");
				} else {
					alert("Location permission was denied");
				}
			});

			// Check if the user has set customProxy. if not, use default proxy
			const tempCustomProxy = getCookie("customProxy");
			if (tempCustomProxy) {
				console.log("Using custom proxy");
				proxyURL = decodeURI(tempCustomProxy);
			} else {
				console.log("Using default proxy");
				proxyURL = "proxy.php";
			}

			// Check if the user is logged in, if not, prompt to login
			const tempTokenRefresh = getCookie("refreshToken");
			if (tempTokenRefresh) {
				user.refreshToken = tempTokenRefresh;
				//tokenRefresh();
			} else {
				openLoginMenu();
			}

			// Prevent resize on keyboard open
			let initialWindowHeight = window.innerHeight;

			document.addEventListener("focusin", e => {
				if (isInputElement(e.target) && (!document.body.style.height.includes("px") || !document.body.style.height)) {
					document.body.style.height = initialWindowHeight + "px";
					window.scrollTo(0, document.body.scrollHeight); // scroll to the bottom of the page
				}
			});

			document.addEventListener("focusout", e => {
				if (isInputElement(e.target)) {
					document.body.style.height = "100%";
				}
			});

			function isInputElement(ele) {
				return (ele && ele.tagName === "INPUT") || ele.tagName === "TEXTAREA" || ele.getAttribute("contenteditable")
					? ele.getAttribute("contenteditable")?.toString() === "true"
					: false;
			}

			// define a custom alert box
			if (document.getElementById) {
				window.alert = message => {
					// set timeout so that if the user clicks on the place where the button is, it doesn't get automatically clicked
					setTimeout(() => createCustomAlert(message), 50);
				};
			}

			// Prevent system back button exiting the app
			window.addEventListener("load", () => window.history.pushState({}, ""));

			// Handle system back button
			window.addEventListener("popstate", () => {
				// Back button was pressed
				window.history.pushState({}, "");

				// Get elements
				let stationMenu = document.getElementById("stationMenu");
				let bikeListMenu = document.getElementById("bikeMenu");
				let tripHistoryMenu = document.getElementById("tripHistory");
				let statisticsMenu = document.getElementById("statisticsMenu");

				// Hide search place menu if it is showing
				hidePlaceSearchMenu();

				// Hide user menu
				if (!tripHistoryMenu && !statisticsMenu) hideUserSettings();

				// Hide trip history menu
				if (tripHistoryMenu) hideTripHistory();

				// Hide statistics menu
				if (statisticsMenu) hideStatisticsMenu();

				// Hide bike list menu if it is showing
				if (bikeListMenu) {
					bikeListMenu.classList.add("smooth-slide-to-bottom");
					setTimeout(() => bikeListMenu.remove(), 500); // remove element after animation
					return; // prevent station card from being hidden if there was a bike list menu
				}

				// Hide station card if it is showing
				if (stationMenu) {
					stationMenu.classList.add("smooth-slide-to-left");
					setTimeout(() => hideStationMenu(), 500); // remove element after animation
					document.getElementById("zoomControls").classList.add("smooth-slide-down-zoom-controls"); // move zoom controls back down
				}
			});

			// Hide station card if the user clicks/taps on the map
			document.getElementById("map").addEventListener("click", () => {
				// Hide station card if it is showing
				let menu = document.getElementById("stationMenu");
				let name = document.getElementById("stationName"); // use this to check if the card is loaded or we are opening a new one
				if (menu && name) {
					console.log("There should be a station menu appearing");
					hideStationMenu();
				}
			});
		</script>
	</body>
</html>
